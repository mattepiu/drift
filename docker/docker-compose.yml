# ============================================================================
# Drift V2 — Docker Compose
# ============================================================================
# Usage:
#   docker compose up drift-mcp          # MCP server (HTTP on port 3100)
#   docker compose run drift-cli scan    # One-shot CLI scan
#   docker compose up drift-ci           # CI mode (scan + check + report)
# ============================================================================

services:
  # ── MCP Server (long-running, HTTP transport) ─────────────────────────────
  drift-mcp:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    ports:
      - "${DRIFT_PORT:-3100}:3100"
    volumes:
      - ${DRIFT_WORKSPACE:-.}:/workspace:ro
      - drift-data:/workspace/.drift
    environment:
      - DRIFT_TRANSPORT=http
      - DRIFT_PORT=3100
      - DRIFT_LOG_LEVEL=${DRIFT_LOG_LEVEL:-info}
      - DRIFT_LICENSE_KEY=${DRIFT_LICENSE_KEY:-}
    command: ["mcp"]
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "2.0"
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3100/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ── CLI (one-shot commands) ───────────────────────────────────────────────
  drift-cli:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    volumes:
      - ${DRIFT_WORKSPACE:-.}:/workspace
      - drift-data:/workspace/.drift
    environment:
      - DRIFT_LOG_LEVEL=${DRIFT_LOG_LEVEL:-info}
      - DRIFT_LICENSE_KEY=${DRIFT_LICENSE_KEY:-}
    profiles:
      - cli

  # ── CI Mode (scan + check + exit) ────────────────────────────────────────
  drift-ci:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    volumes:
      - ${DRIFT_WORKSPACE:-.}:/workspace
      - drift-data:/workspace/.drift
    environment:
      - DRIFT_LOG_LEVEL=${DRIFT_LOG_LEVEL:-info}
      - DRIFT_LICENSE_KEY=${DRIFT_LICENSE_KEY:-}
      - CI=true
    command: ["check"]
    profiles:
      - ci
    deploy:
      resources:
        limits:
          memory: 512M

volumes:
  drift-data:
    driver: local
